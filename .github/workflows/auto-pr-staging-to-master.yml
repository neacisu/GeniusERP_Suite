name: Auto-create PR staging â†’ master

# Acest workflow creeazÄƒ MANUAL un PR staging â†’ master
# IMPORTANT: Acest PR nu va fi NICIODATÄ‚ merge-uit automat!

on:
  workflow_dispatch:  # Trigger MANUAL prin GitHub UI
    inputs:
      reason:
        description: 'Motivul pentru crearea PR-ului cÄƒtre production'
        required: true
        type: string

permissions:
  contents: read
  pull-requests: write

jobs:
  create-pr:
    name: Create PR staging â†’ master (MANUAL)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: staging

      - name: VerificÄƒ dacÄƒ staging este ahead de master
        id: check-commits
        run: |
          git fetch origin master:master
          COMMITS_AHEAD=$(git rev-list --count master..staging)
          echo "commits_ahead=$COMMITS_AHEAD" >> $GITHUB_OUTPUT

          if [ "$COMMITS_AHEAD" -gt 0 ]; then
            echo "âœ… Staging este ahead cu $COMMITS_AHEAD commit-uri faÈ›Äƒ de master"
            echo "has_new_commits=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Staging È™i master sunt sincronizate. Nu este necesarÄƒ crearea unui PR."
            echo "has_new_commits=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: VerificÄƒ dacÄƒ existÄƒ PR deschis
        id: check-pr
        run: |
          PR_COUNT=$(gh pr list --base master --head staging --state open --json number --jq length)
          echo "pr_count=$PR_COUNT" >> $GITHUB_OUTPUT

          if [ "$PR_COUNT" -gt 0 ]; then
            echo "âœ… PR staging â†’ master deja existÄƒ"
            PR_NUMBER=$(gh pr list --base master --head staging --state open --json number --jq '.[0].number')
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "pr_exists=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Nu existÄƒ PR staging â†’ master"
            echo "pr_exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Extrage changesets
        id: changesets
        if: steps.check-pr.outputs.pr_exists == 'false'
        run: |
          # Extrage lista de changesets din staging
          if [ -d ".changeset" ]; then
            CHANGESETS=$(find .changeset -maxdepth 1 -name '*.md' ! -name 'README.md' -exec basename {} \; | head -10)
            if [ -n "$CHANGESETS" ]; then
              echo "has_changesets=true" >> $GITHUB_OUTPUT
              echo "changesets<<EOF" >> $GITHUB_OUTPUT
              echo "$CHANGESETS" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            else
              echo "has_changesets=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_changesets=false" >> $GITHUB_OUTPUT
          fi

      - name: GenereazÄƒ PR body
        id: pr-body
        if: steps.check-pr.outputs.pr_exists == 'false' && steps.check-commits.outputs.has_new_commits == 'true'
        run: |
          # GenereazÄƒ lista detaliatÄƒ de commit-uri
          COMMITS=$(git log master..staging --pretty=format:"- %s (%h) - %an" --no-merges | head -30)
          TOTAL_COMMITS=$(git rev-list --count master..staging --no-merges)
          
          # CalculeazÄƒ statistici
          FILES_CHANGED=$(git diff --stat master...staging | tail -1)
          
          cat << 'EOF' > pr_body.md
          ## ğŸš€ Release Production

          Acest PR promoveazÄƒ schimbÄƒrile din `staging` cÄƒtre `master` pentru deployment Ã®n **PRODUCTION**.

          ### âš ï¸ IMPORTANT - CITEÈ˜TE CU ATENÈšIE

          - âœ… Acest PR a fost creat **MANUAL** prin workflow automation
          - âŒ Acest PR **NU va fi merge-uit automat** - necesitÄƒ aprobare manualÄƒ
          - ğŸ” **Review obligatoriu** de la cel puÈ›in un maintainer
          - ğŸ§ª **Testare completÄƒ Ã®n staging** este OBLIGATORIE Ã®nainte de aprobare

          ### ğŸ“‹ Pre-merge Checklist

          - [ ] âœ… Toate schimbÄƒrile au fost testate Ã®n **staging**
          - [ ] âœ… Testare funcÈ›ionalÄƒ completÄƒ efectuatÄƒ
          - [ ] âœ… Testare de regresie efectuatÄƒ (dacÄƒ aplicabil)
          - [ ] âœ… Testare de performanÈ›Äƒ efectuatÄƒ (dacÄƒ aplicabil)
          - [ ] âœ… DocumentaÈ›ia este actualizatÄƒ
          - [ ] âœ… CHANGELOG.md este corect generat
          - [ ] âœ… MigrÄƒrile de bazÄƒ de date sunt testate
          - [ ] âœ… Rollback plan este pregÄƒtit
          - [ ] âœ… Monitoring È™i alerting sunt configurate
          - [ ] âœ… Stakeholders sunt notificaÈ›i

          EOF

          # AdaugÄƒ motivul
          echo "### ğŸ¯ Motivul Release-ului" >> pr_body.md
          echo "" >> pr_body.md
          echo "${{ github.event.inputs.reason }}" >> pr_body.md
          echo "" >> pr_body.md

          # AdaugÄƒ changesets dacÄƒ existÄƒ
          if [ "${{ steps.changesets.outputs.has_changesets }}" == "true" ]; then
            echo "### ğŸ“¦ Changesets Detectate" >> pr_body.md
            echo "" >> pr_body.md
            echo "\`\`\`" >> pr_body.md
            echo "${{ steps.changesets.outputs.changesets }}" >> pr_body.md
            echo "\`\`\`" >> pr_body.md
            echo "" >> pr_body.md
          fi

          # AdaugÄƒ statistici
          echo "### ğŸ“Š Statistici" >> pr_body.md
          echo "" >> pr_body.md
          echo "- ğŸ“ Commit-uri: **$TOTAL_COMMITS**" >> pr_body.md
          echo "- ğŸ“ FiÈ™iere modificate: \`$FILES_CHANGED\`" >> pr_body.md
          echo "" >> pr_body.md

          # AdaugÄƒ lista de commit-uri
          echo "### ğŸ“ Commit-uri Incluse" >> pr_body.md
          echo "" >> pr_body.md
          if [ "$TOTAL_COMMITS" -le 30 ]; then
            echo "$COMMITS" >> pr_body.md
          else
            echo "$COMMITS" >> pr_body.md
            echo "" >> pr_body.md
            echo "... È™i alte $((TOTAL_COMMITS - 30)) commit-uri. Vezi istoricul complet Ã®n tab-ul Commits." >> pr_body.md
          fi
          echo "" >> pr_body.md

          # AdaugÄƒ instrucÈ›iuni de deployment
          cat << 'EOF' >> pr_body.md

          ### ğŸš€ Deployment Steps (DupÄƒ Merge)

          1. **Merge acest PR** â†’ Triggere workflow `release.yml`
          2. **VerificÄƒ release-ul** â†’ Changesets vor versiona automat pachetele
          3. **CreeazÄƒ GitHub Release** â†’ Triggere workflow `deploy-prod.yml`
          4. **MonitorizeazÄƒ deployment** â†’ VerificÄƒ GHCR È™i logs
          5. **Smoke testing** â†’ ValideazÄƒ aplicaÈ›iile Ã®n production
          6. **NotificÄƒ echipa** â†’ ComunicÄƒ release-ul

          ### ğŸ”„ Rollback Plan

          DacÄƒ ceva nu funcÈ›ioneazÄƒ corect dupÄƒ deployment:

          ```bash
          # Revert merge commit-ul
          git revert -m 1 <merge_commit_sha>
          git push origin master

          # SAU deploy release-ul anterior
          gh release view --json tagName
          # Apoi re-deploy imaginea Docker cu tag-ul anterior
          ```

          ---

          **âš ï¸ REMINDER**: Acest PR necesitÄƒ **aprobare manualÄƒ explicitÄƒ**. Nu va fi merge-uit automat.

          **Creat de**: @${{ github.actor }}  
          **Data**: $(date +"%Y-%m-%d %H:%M:%S UTC")
          EOF

      - name: CreeazÄƒ Pull Request
        if: steps.check-pr.outputs.pr_exists == 'false' && steps.check-commits.outputs.has_new_commits == 'true'
        run: |
          gh pr create \
            --base master \
            --head staging \
            --title "ğŸš€ Release Production: staging â†’ master" \
            --body-file pr_body.md \
            --label "production-release" \
            --label "requires-review" \
            --reviewer @${{ github.actor }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: AdaugÄƒ comentariu dacÄƒ PR deja existÄƒ
        if: steps.check-pr.outputs.pr_exists == 'true'
        run: |
          gh pr comment ${{ steps.check-pr.outputs.pr_number }} \
            --body "â™»ï¸ **Workflow re-rulat**

          Un utilizator a Ã®ncercat sÄƒ creeze din nou PR-ul staging â†’ master, dar acesta deja existÄƒ.

          **Motiv furnizat**: ${{ github.event.inputs.reason }}

          **RugÄƒminte**: Te rog revizuieÈ™te acest PR existent È™i merge-uieÈ™te-l cÃ¢nd eÈ™ti gata pentru production release.

          **Creat de**: @${{ github.actor }}  
          **Data**: $(date +"%Y-%m-%d %H:%M:%S UTC")"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          if [ "${{ steps.check-pr.outputs.pr_exists }}" == "true" ]; then
            echo "âœ… PR staging â†’ master deja existÄƒ (PR #${{ steps.check-pr.outputs.pr_number }})"
            echo "ğŸ“ Comentariu adÄƒugat la PR-ul existent"
          else
            echo "âœ… PR staging â†’ master a fost creat cu succes!"
            echo "ğŸ”— VerificÄƒ PR-ul: https://github.com/${{ github.repository }}/pulls"
          fi
          echo ""
          echo "âš ï¸ IMPORTANT: Acest PR necesitÄƒ aprobare manualÄƒ È™i NU va fi merge-uit automat!"

