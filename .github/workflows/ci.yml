name: CI Validation

# CI workflow principal pentru GeniusSuite – configurat în F0.2.3+
on:
  pull_request:
    branches:
      - master
      - staging
      - dev
  push:
    branches:
      - dev
      # Rulează CI și după merge-uri în dev pentru a valida codul înainte de promovare
jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24.x
          check-latest: true
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10
      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Set Nx SHAs
        uses: nrwl/nx-set-shas@v4
      - name: Connect to Nx Cloud (for caching only)
        continue-on-error: true
        env:
          NX_CLOUD_AUTH_TOKEN: ${{ secrets.NX_CLOUD_AUTH_TOKEN }}
        run: |
          # Enable Nx Cloud for remote caching, but disable distributed execution
          echo "NX_CLOUD_DISTRIBUTED_EXECUTION=false" >> $GITHUB_ENV
      # Run Jest tests for configuration validation
      - name: Run configuration tests
        run: pnpm test
      # Nx affected commands
      - name: Check formatting (affected)
        continue-on-error: true
        run: pnpm exec nx affected -t format:check || echo "⚠️ No affected projects"
      - name: Lint affected projects
        continue-on-error: true
        run: pnpm exec nx affected -t lint || echo "⚠️ No affected projects"
      - name: Test affected projects
        continue-on-error: true
        run: pnpm exec nx affected -t test || echo "⚠️ No affected projects"
      - name: Build affected projects
        run: pnpm exec nx affected -t build --verbose

  observability-validate:
    runs-on: ubuntu-latest
    # Run only on PRs to dev/staging and pushes to dev/staging
    if: |
      (github.event_name == 'pull_request' && 
        (github.base_ref == 'dev' || github.base_ref == 'staging')) ||
      (github.event_name == 'push' && 
        (github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/staging'))
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create Docker networks (Zero-Trust topology)
        run: |
          echo "Creating 4-zone Zero-Trust network topology..."
          docker network create geniuserp_net_edge || true
          docker network create geniuserp_net_suite_internal || true
          docker network create geniuserp_net_backing_services || true
          docker network create geniuserp_net_observability || true

      - name: Create named volumes (data persistence)
        run: |
          echo "Creating named volumes for stateful services..."
          # Observability volumes
          docker volume create gs_prometheus_data || true
          docker volume create gs_loki_data || true
          docker volume create gs_grafana_data || true
          docker volume create gs_tempo_data || true
          # Backing services volumes
          docker volume create gs_pgdata_identity || true
          docker volume create gs_pgdata_licensing || true
          docker volume create gs_pgdata_archify || true
          docker volume create gs_pgdata_vettify || true
          docker volume create gs_kafka_data || true

      - name: Create CI environment files from secrets
        env:
          POSTGRES_PASSWORD: ${{ secrets.CI_POSTGRES_PASSWORD || 'ci_test_pass_temp_123' }}
          KAFKA_PASSWORD: ${{ secrets.CI_KAFKA_PASSWORD || 'ci_kafka_pass_temp_456' }}
          GRAFANA_PASSWORD: ${{ secrets.CI_GRAFANA_PASSWORD || 'ci_grafana_pass_temp_789' }}
          SUPERTOKENS_API_KEY: ${{ secrets.CP_IDT_AUTH_SUPERTOKENS_API_KEY || 'MT10OM5PMOIHCUKF-MF87-OKJSIYXZT-LTEVZRQWEUFOM9TCI5MOQN9BGS8DYEIOGD2YXZSECAZ5SW2EZG3MD7NVTPF8DZUZ8LXQITVNXGIKW7H4AJOYMO-OV6UQLLIL' }}
        run: |
          set -euo pipefail

            update_env_var() {
            local file="$1"
            local key="$2"
            local value="$3"
            python - "$file" "$key" "$value" <<'PY'
      import sys
      from pathlib import Path

      path = Path(sys.argv[1])
      key = sys.argv[2]
      value = sys.argv[3]
      lines = path.read_text().splitlines()

      for idx, line in enumerate(lines):
        if line.startswith(f"{key}="):
          lines[idx] = f"{key}={value}"
          break
      else:
        lines.append(f"{key}={value}")

      path.write_text("\n".join(lines) + "\n")
      PY
            }

          echo "Hydrating .suite.general.env from template..."
          cp .suite.general.env.example .suite.general.env
          update_env_var ".suite.general.env" "SUITE_DB_POSTGRES_PASS" "${POSTGRES_PASSWORD}"
          update_env_var ".suite.general.env" "SUITE_MQ_KAFKA_PASS" "${KAFKA_PASSWORD}"
          update_env_var ".suite.general.env" "SUITE_OBS_OTEL_COLLECTOR_GRPC_URL" "http://geniuserp-otel-collector:4317"
          update_env_var ".suite.general.env" "SUITE_OBS_OTEL_COLLECTOR_HTTP_URL" "http://geniuserp-otel-collector:4318"
          update_env_var ".suite.general.env" "SUITE_OBS_GRAFANA_URL" "http://grafana:3000"
          update_env_var ".suite.general.env" "SUITE_OBS_PROMETHEUS_URL" "http://prometheus:9090"
          update_env_var ".suite.general.env" "SUITE_OBS_LOKI_URL" "http://loki:3100"
          update_env_var ".suite.general.env" "SUITE_OBS_TEMPO_URL" "http://tempo:3200"

          echo "Creating .backing-services.env for CI..."
          cat > .backing-services.env << EOF
          # Backing services secrets for CI
          SUITE_DB_POSTGRES_USER=suite_admin
          SUITE_DB_POSTGRES_PASS=${POSTGRES_PASSWORD}
          SUITE_DB_POSTGRES_PORT=5432
          CP_IDT_AUTH_SUPERTOKENS_CONNECTION_URI=http://supertokens-core:3567
          CP_IDT_AUTH_SUPERTOKENS_API_KEY=${SUPERTOKENS_API_KEY}
          EOF

          echo "Creating .observability.env for CI..."
          cat > shared/observability/.observability.env << EOF
          # Observability CI Config
          OBS_GRAFANA_ADMIN_USER=admin
          OBS_GRAFANA_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
          OBS_PROMETHEUS_RETENTION=7d
          OBS_LOKI_RETENTION=3d
          EOF
          
          echo "Creating Control Plane .env files..."
          # CP suite-shell (path relative to compose/)
          cat > cp/suite-shell/.cp.suite-shell.env << EOF
          CP_SHELL_APP_PORT=6100
          CP_SHELL_APP_METRICS_PORT=6101
          CP_SHELL_APP_NODE_ENV=development
          CP_SHELL_OBS_SERVICE_NAME=suite-shell
          OTEL_EXPORTER_OTLP_ENDPOINT=http://geniuserp-otel-collector:4318/v1/traces
          EOF
          
          # CP suite-admin
          cat > cp/suite-admin/.cp.suite-admin.env << EOF
          CP_ADMIN_APP_PORT=6150
          CP_ADMIN_APP_METRICS_PORT=6151
          CP_ADMIN_APP_NODE_ENV=development
          CP_ADMIN_OBS_SERVICE_NAME=suite-admin
          OTEL_EXPORTER_OTLP_ENDPOINT=http://geniuserp-otel-collector:4318/v1/traces
          EOF
          
          # CP suite-login
          cat > cp/suite-login/.cp.suite-login.env << EOF
          CP_LOGIN_APP_PORT=6200
          CP_LOGIN_APP_METRICS_PORT=6201
          CP_LOGIN_APP_NODE_ENV=development
          CP_LOGIN_OBS_SERVICE_NAME=suite-login
          OTEL_EXPORTER_OTLP_ENDPOINT=http://geniuserp-otel-collector:4318/v1/traces
          EOF
          
          # CP identity
          cat > cp/identity/.cp.identity.env << EOF
          CP_IDT_APP_PORT=6250
          CP_IDT_APP_METRICS_PORT=6251
          CP_IDT_APP_NODE_ENV=development
          CP_IDT_OBS_SERVICE_NAME=identity
          OTEL_EXPORTER_OTLP_ENDPOINT=http://geniuserp-otel-collector:4318/v1/traces
          EOF
          
          # CP licensing
          cat > cp/licensing/.cp.licensing.env << EOF
          CP_LIC_APP_PORT=6300
          CP_LIC_APP_METRICS_PORT=6301
          CP_LIC_APP_NODE_ENV=development
          CP_LIC_OBS_SERVICE_NAME=licensing
          OTEL_EXPORTER_OTLP_ENDPOINT=http://geniuserp-otel-collector:4318/v1/traces
          EOF
          
          # CP analytics-hub
          cat > cp/analytics-hub/.cp.analytics-hub.env << EOF
          CP_ANLY_APP_PORT=6350
          CP_ANLY_APP_METRICS_PORT=6351
          CP_ANLY_APP_NODE_ENV=development
          CP_ANLY_OBS_SERVICE_NAME=analytics-hub
          OTEL_EXPORTER_OTLP_ENDPOINT=http://geniuserp-otel-collector:4318/v1/traces
          EOF
          
          # CP ai-hub
          cat > cp/ai-hub/.cp.ai-hub.env << EOF
          CP_AI_APP_PORT=6400
          CP_AI_APP_METRICS_PORT=6401
          CP_AI_APP_NODE_ENV=development
          CP_AI_OBS_SERVICE_NAME=ai-hub
          OTEL_EXPORTER_OTLP_ENDPOINT=http://geniuserp-otel-collector:4318/v1/traces
          EOF
          
          echo "Creating stand-alone app .env files..."
          # archify.app (path relative to compose/)
          cat > archify.app/.archify.env << EOF
          ARCHIFY_APP_PORT=6500
          ARCHIFY_APP_METRICS_PORT=6501
          ARCHIFY_APP_NODE_ENV=development
          ARCHIFY_OBS_SERVICE_NAME=archify.app
          EOF
          
          # cerniq.app
          cat > cerniq.app/.cerniq.env << EOF
          CERNIQ_APP_PORT=6550
          CERNIQ_APP_METRICS_PORT=6551
          CERNIQ_APP_NODE_ENV=development
          CERNIQ_OBS_SERVICE_NAME=cerniq.app
          EOF
          
          # flowxify.app
          cat > flowxify.app/.flowxify.env << EOF
          FLOWXIFY_APP_PORT=6600
          FLOWXIFY_APP_METRICS_PORT=6601
          FLOWXIFY_APP_NODE_ENV=development
          FLOWXIFY_OBS_SERVICE_NAME=flowxify.app
          EOF
          
          # i-wms.app
          cat > i-wms.app/.i-wms.env << EOF
          IWMS_APP_PORT=6650
          IWMS_APP_METRICS_PORT=6651
          IWMS_APP_NODE_ENV=development
          IWMS_OBS_SERVICE_NAME=i-wms.app
          EOF
          
          # mercantiq.app
          cat > mercantiq.app/.mercantiq.env << EOF
          MERCANTIQ_APP_PORT=6700
          MERCANTIQ_APP_METRICS_PORT=6701
          MERCANTIQ_APP_NODE_ENV=development
          MERCANTIQ_OBS_SERVICE_NAME=mercantiq.app
          EOF
          
          # numeriqo.app
          cat > numeriqo.app/.numeriqo.env << EOF
          NUMERIQO_APP_PORT=6750
          NUMERIQO_APP_METRICS_PORT=6751
          NUMERIQO_APP_NODE_ENV=development
          NUMERIQO_OBS_SERVICE_NAME=numeriqo.app
          EOF
          
          # triggerra.app
          cat > triggerra.app/.triggerra.env << EOF
          TRIGGERRA_APP_PORT=6800
          TRIGGERRA_APP_METRICS_PORT=6801
          TRIGGERRA_APP_NODE_ENV=development
          TRIGGERRA_OBS_SERVICE_NAME=triggerra.app
          EOF
          
          # vettify.app
          cat > vettify.app/.vettify.env << EOF
          VETTIFY_APP_PORT=6850
          VETTIFY_APP_METRICS_PORT=6851
          VETTIFY_APP_NODE_ENV=development
          VETTIFY_OBS_SERVICE_NAME=vettify.app
          EOF
          
          echo "✓ All environment files created (17 services)"
          echo "Verifying created files..."
          ls -la cp/suite-shell/.cp.suite-shell.env archify.app/.archify.env 2>/dev/null || echo "Warning: Some files may not exist"

      - name: Start backing services (PostgreSQL, Kafka, Temporal, SuperTokens)
        run: |
          echo "Starting backing services on net_backing_services..."
          docker compose -f docker-compose.backing-services.yml up -d
          echo "Waiting for backing services to be healthy..."
          sleep 60
        timeout-minutes: 5

      - name: Start observability stack (Prometheus, Grafana, Loki, OTEL)
        working-directory: shared/observability
        run: |
          echo "Starting observability stack..."
          bash scripts/install.sh dev
          echo "Waiting for observability stack to be ready..."
          sleep 60
        timeout-minutes: 5

      - name: Start Control Plane services (7 services)
        run: |
          echo "Starting Control Plane services..."
          # Export env vars for docker-compose interpolation
          export $(grep -v '^#' cp/suite-shell/.cp.suite-shell.env | xargs)
          export $(grep -v '^#' .suite.general.env | xargs)
          # Suite core (6100-6249)
          docker compose -f cp/suite-shell/compose/docker-compose.yml up -d
          
          export $(grep -v '^#' cp/suite-admin/.cp.suite-admin.env | xargs)
          docker compose -f cp/suite-admin/compose/docker-compose.yml up -d
          
          export $(grep -v '^#' cp/suite-login/.cp.suite-login.env | xargs)
          docker compose -f cp/suite-login/compose/docker-compose.yml up -d
          
          # Identity & Licensing (6250-6349)
          export $(grep -v '^#' cp/identity/.cp.identity.env | xargs)
          docker compose -f cp/identity/compose/docker-compose.yml up -d
          
          export $(grep -v '^#' cp/licensing/.cp.licensing.env | xargs)
          docker compose -f cp/licensing/compose/docker-compose.yml up -d
          
          # Analytics & AI (6350-6449)
          export $(grep -v '^#' cp/analytics-hub/.cp.analytics-hub.env | xargs)
          docker compose -f cp/analytics-hub/compose/docker-compose.yml up -d
          
          export $(grep -v '^#' cp/ai-hub/.cp.ai-hub.env | xargs)
          docker compose -f cp/ai-hub/compose/docker-compose.yml up -d
          
          echo "Waiting for CP services to start..."
          sleep 60
        timeout-minutes: 10

      - name: Start stand-alone applications (8 apps)
        run: |
          echo "Starting stand-alone applications (6500-6899)..."
          # Export and start each app
          export $(grep -v '^#' archify.app/.archify.env | xargs)
          docker compose -f archify.app/compose/docker-compose.yml up -d
          
          export $(grep -v '^#' cerniq.app/.cerniq.env | xargs)
          docker compose -f cerniq.app/compose/docker-compose.yml up -d
          
          export $(grep -v '^#' flowxify.app/.flowxify.env | xargs)
          docker compose -f flowxify.app/compose/docker-compose.yml up -d
          
          export $(grep -v '^#' i-wms.app/.i-wms.env | xargs)
          docker compose -f i-wms.app/compose/docker-compose.yml up -d
          
          export $(grep -v '^#' mercantiq.app/.mercantiq.env | xargs)
          docker compose -f mercantiq.app/compose/docker-compose.yml up -d
          
          export $(grep -v '^#' numeriqo.app/.numeriqo.env | xargs)
          docker compose -f numeriqo.app/compose/docker-compose.yml up -d
          
          export $(grep -v '^#' triggerra.app/.triggerra.env | xargs)
          docker compose -f triggerra.app/compose/docker-compose.yml up -d
          
          export $(grep -v '^#' vettify.app/.vettify.env | xargs)
          docker compose -f vettify.app/compose/docker-compose.yml up -d
          
          echo "Waiting for applications to be healthy..."
          sleep 70
        timeout-minutes: 10

      - name: Show running containers status
        if: always()
        run: |
          echo "=== All running containers ==="
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          echo ""
          echo "=== Container count by status ==="
          docker ps -a --format "{{.Status}}" | cut -d' ' -f1 | sort | uniq -c

      - name: Run complete infrastructure validation (38 checks)
        working-directory: shared/observability
        run: |
          echo "Running complete validation suite..."
          bash scripts/validate.sh
        timeout-minutes: 5

      - name: Show validation logs on failure
        if: failure()
        run: |
          echo "=== Grafana logs ==="
          docker logs profiles-grafana-1 --tail 100 || true
          echo "=== Prometheus logs ==="
          docker logs profiles-prometheus-1 --tail 100 || true
          echo "=== Loki logs ==="
          docker logs profiles-loki-1 --tail 100 || true
          echo "=== OTEL Collector logs ==="
          docker logs geniuserp-otel-collector --tail 100 || true
          echo "=== PostgreSQL logs ==="
          docker logs postgres-backing-1 --tail 50 || true
          echo "=== Sample CP service logs ==="
          docker logs cp-identity-1 --tail 50 || true
          docker logs cp-suite-shell-1 --tail 50 || true
          echo "=== Sample app logs ==="
          docker logs archify-app-1 --tail 50 || true
          docker logs vettify-app-1 --tail 50 || true

      - name: Cleanup
        if: always()
        run: |
          echo "Stopping all services..."
          sleep 100
          docker compose -f archify.app/compose/docker-compose.yml down || true
          docker compose -f cerniq.app/compose/docker-compose.yml down || true
          docker compose -f flowxify.app/compose/docker-compose.yml down || true
          docker compose -f i-wms.app/compose/docker-compose.yml down || true
          docker compose -f mercantiq.app/compose/docker-compose.yml down || true
          docker compose -f numeriqo.app/compose/docker-compose.yml down || true
          docker compose -f triggerra.app/compose/docker-compose.yml down || true
          docker compose -f vettify.app/compose/docker-compose.yml down || true
          docker compose -f cp/suite-shell/compose/docker-compose.yml down || true
          docker compose -f cp/suite-admin/compose/docker-compose.yml down || true
          docker compose -f cp/suite-login/compose/docker-compose.yml down || true
          docker compose -f cp/identity/compose/docker-compose.yml down || true
          docker compose -f cp/licensing/compose/docker-compose.yml down || true
          docker compose -f cp/analytics-hub/compose/docker-compose.yml down || true
          docker compose -f cp/ai-hub/compose/docker-compose.yml down || true
          docker compose -f shared/observability/compose/profiles/compose.dev.yml down || true
          docker compose -f shared/backing-services/docker-compose.backing-services.yml down || true
          echo "Cleanup complete"