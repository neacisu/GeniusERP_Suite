name: F0.5 Security Validation

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *' # Nightly at 2 AM

permissions:
  contents: read
  id-token: write

jobs:
  validate-security:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare env templates
        run: |
          cp -f .suite.general.env.example .suite.general.env
          cp -f proxy/.proxy.env.example proxy/.proxy.env

      - name: Install required packages
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Build node-openbao base image
        run: docker build -f shared/docker/node-openbao.Dockerfile -t geniuserp/node-openbao:local .

      - name: Bootstrap OpenBao (init, approles, secrets)
        env:
          BAO_ADDR: http://127.0.0.1:8200
        run: |
          chmod +x scripts/security/ci-bootstrap-openbao.sh
          scripts/security/ci-bootstrap-openbao.sh ci

      - name: Start Traefik proxy for chaos test
        run: docker compose up -d proxy

      - name: Verify Process Supervisor artifacts
        run: |
          chmod +x scripts/security/verify_all_apps.sh
          scripts/security/verify_all_apps.sh

      - name: Validate OpenBao KV inventory
        env:
          BAO_ADDR: http://127.0.0.1:8200
        run: |
          chmod +x scripts/security/test-openbao-secrets.sh
          scripts/security/test-openbao-secrets.sh

      - name: Run chaos scenario (proxy)
        env:
          BAO_ADDR: http://127.0.0.1:8200
        run: |
          chmod +x scripts/security/test-f05-chaos.sh
          scripts/security/test-f05-chaos.sh proxy
