name: Auto-create PR dev â†’ staging

# Trigger: DupÄƒ ce CI Validation trece cu succes pe branch-ul dev
on:
  workflow_run:
    workflows: ["CI Validation"]
    types: [completed]
    branches: [dev]

permissions:
  contents: read
  pull-requests: write

jobs:
  create-pr:
    name: Create PR dev â†’ staging
    runs-on: ubuntu-latest
    # RuleazÄƒ doar dacÄƒ CI a trecut cu succes
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necesare pentru comparare branch-uri
          ref: dev

      - name: Check if PR already exists
        id: check-pr
        run: |
          # VerificÄƒ dacÄƒ existÄƒ deja un PR deschis dev â†’ staging
          PR_COUNT=$(gh pr list --base staging --head dev --state open --json number --jq length)
          echo "pr_count=$PR_COUNT" >> $GITHUB_OUTPUT

          if [ "$PR_COUNT" -gt 0 ]; then
            echo "âœ… PR dev â†’ staging deja existÄƒ"
            echo "pr_exists=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Nu existÄƒ PR dev â†’ staging"
            echo "pr_exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_TOKEN }}

      - name: Check if there are new commits
        id: check-commits
        if: steps.check-pr.outputs.pr_exists == 'false'
        run: |
          # VerificÄƒ dacÄƒ dev este ahead of staging
          git fetch origin staging:staging
          COMMITS_AHEAD=$(git rev-list --count staging..dev)
          echo "commits_ahead=$COMMITS_AHEAD" >> $GITHUB_OUTPUT

          if [ "$COMMITS_AHEAD" -gt 0 ]; then
            echo "âœ… Dev este ahead cu $COMMITS_AHEAD commit-uri faÈ›Äƒ de staging"
            echo "has_new_commits=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ Dev È™i staging sunt sincronizate"
            echo "has_new_commits=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate PR body
        id: pr-body
        if: steps.check-pr.outputs.pr_exists == 'false' && steps.check-commits.outputs.has_new_commits == 'true'
        run: |
          # GenereazÄƒ lista de commit-uri pentru PR body
          COMMITS=$(git log staging..dev --pretty=format:"- %%s (%%h)" --no-merges | head -20)

          # DacÄƒ sunt mai mult de 20 commit-uri, adaugÄƒ note
          TOTAL_COMMITS=$(git rev-list --count staging..dev --no-merges)
          if [ "$TOTAL_COMMITS" -gt 20 ]; then
            COMMITS="$COMMITS

            Mai existÄƒ $((TOTAL_COMMITS - 20)) commit-uri. Vezi istoricul complet Ã®n tab-ul Commits."
          fi

          # CreeazÄƒ PR body
          cat > pr_body.md << 'EOF'
          ## ğŸš€ Promovare automatÄƒ dev â†’ staging

          Acest PR a fost creat automat dupÄƒ ce CI Validation a trecut cu succes pe branch-ul `dev`.

          ### ğŸ“‹ Checklist Ã®nainte de merge

          - [ ] CI Validation a trecut (verificat automat)
          - [ ] Changesets sunt prezente pentru toate modificÄƒrile de pachete
          - [ ] Testare funcÈ›ionalÄƒ efectuatÄƒ local
          - [ ] DocumentaÈ›ia este actualizatÄƒ (dacÄƒ e cazul)
          - [ ] Breaking changes sunt documentate Ã®n changesets

          ### ğŸ“ Commit-uri incluse

          EOF

          echo "$COMMITS" >> pr_body.md

          cat >> pr_body.md << 'EOF'

          ### ğŸ¯ Next Steps

          1. **Review**: VerificÄƒ modificÄƒrile Ã®n tab-ul "Files changed"
          2. **Testare**: TesteazÄƒ Ã®n staging dupÄƒ merge
          3. **Label**: AdaugÄƒ label-ul `ready-for-staging` cÃ¢nd eÈ™ti gata pentru auto-merge (opÈ›ional)

          ---

          **âš ï¸ IMPORTANT**: Acest PR **NU va fi merge-uit automat**. NecesitÄƒ aprobare manualÄƒ.

          Pentru auto-merge, adaugÄƒ label-ul `ready-for-staging` dupÄƒ ce toate verificÄƒrile au trecut.
          EOF

          # SalveazÄƒ PR body pentru urmÄƒtorul pas
          echo "pr_body_path=pr_body.md" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check-pr.outputs.pr_exists == 'false' && steps.check-commits.outputs.has_new_commits == 'true'
        run: |
          gh pr create \
            --base staging \
            --head dev \
            --title "ğŸš€ Promovare dev â†’ staging (auto)" \
            --body-file pr_body.md \
            --label "auto-created"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_TOKEN }}


      - name: Summary
        run: |
          if [ "${{ steps.check-pr.outputs.pr_exists }}" == "true" ]; then
            echo "âœ… PR dev â†’ staging deja existÄƒ. Nu este necesarÄƒ crearea unui nou PR."
          elif [ "${{ steps.check-commits.outputs.has_new_commits }}" == "false" ]; then
            echo "â„¹ï¸ Dev È™i staging sunt sincronizate. Nu este necesarÄƒ crearea unui PR."
          else
            echo "âœ… PR dev â†’ staging a fost creat cu succes!"
            echo "ğŸ”— VerificÄƒ PR-ul: https://github.com/${{ github.repository }}/pulls"
          fi

