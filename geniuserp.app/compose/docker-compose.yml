services:
  geniuserp-app:
    build:
      context: ../..
      dockerfile: geniuserp.app/Dockerfile
    container_name: ${GERP_CONTAINER_NAME}
    restart: ${GERP_RESTART_POLICY}
    env_file:
      - ../../.suite.general.env
      - ../.geniuserp.env
    environment:
      - GENERP_APP_PORT=${GENERP_APP_PORT}
      - GENERP_APP_METRICS_PORT=${GENERP_APP_METRICS_PORT}
      - GENERP_APP_NODE_ENV=${GENERP_APP_NODE_ENV:-production}
      - PORT=${GENERP_APP_PORT}
      - OTEL_SERVICE_NAME=${GERP_OTEL_SERVICE_NAME}
      - SUITE_OBS_OTEL_COLLECTOR_GRPC_URL=${SUITE_OBS_OTEL_COLLECTOR_GRPC_URL}
      - LOG_LEVEL=${GERP_LOG_LEVEL}
          - BAO_AGENT_CONFIG=${GERP_BAO_AGENT_CONFIG}
      - SUITE_DB_POSTGRES_HOST=${SUITE_DB_POSTGRES_HOST}
      - SUITE_DB_POSTGRES_PORT=${SUITE_DB_POSTGRES_PORT}
    volumes:
      - ${GERP_APPROLE_ROLE_ID_PATH}:/openbao/role-id:ro
      - ${GERP_APPROLE_SECRET_ID_PATH}:/openbao/secret-id:ro
    networks:
      - net_suite_internal
      - net_backing_services
      - net_observability
    labels:
      - traefik.enable=true
      - traefik.docker.network=${PROXY_NETWORK_INTERNAL}
      - traefik.http.routers.geniuserp.rule=Host(`${SUITE_APP_DOMAIN:-geniuserp.app}`) || Host(`www.${SUITE_APP_DOMAIN:-geniuserp.app}`)
      - traefik.http.routers.geniuserp.entrypoints=websecure
      - traefik.http.routers.geniuserp.tls=true
      - traefik.http.routers.geniuserp.tls.certresolver=letsencrypt
      - traefik.http.routers.geniuserp.middlewares=global-chain@file
      - traefik.http.services.geniuserp.loadbalancer.server.port=${GENERP_APP_PORT}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${GENERP_APP_PORT}/health"]
      interval: ${GERP_HEALTHCHECK_INTERVAL}
      timeout: ${GERP_HEALTHCHECK_TIMEOUT}
      retries: ${GERP_HEALTHCHECK_RETRIES}
      start_period: ${GERP_HEALTHCHECK_START_PERIOD}

networks:
  net_suite_internal:
    external: true
    name: geniuserp_net_suite_internal
  net_backing_services:
    external: true
    name: geniuserp_net_backing_services
  net_observability:
    external: true
    name: geniuserp_net_observability
