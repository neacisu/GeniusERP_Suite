services:
  archify-app:
    build:
      context: ../..
      dockerfile: archify.app/Dockerfile
    container_name: genius-suite-archify-app
    restart: unless-stopped
    env_file:
      - ../../.suite.general.env
      - ../.archify.env
    environment:
      - ARCHY_APP_PORT=${ARCHY_APP_PORT}
      - ARCHY_APP_METRICS_PORT=${ARCHY_APP_METRICS_PORT}
      - ARCHY_APP_WORKER_PORT=${ARCHY_APP_WORKER_PORT}
      - ARCHY_APP_NODE_ENV=${ARCHY_APP_NODE_ENV}
      - PORT=${ARCHY_APP_PORT:-6500}
      - OTEL_SERVICE_NAME=archify.app
      - SUITE_OBS_OTEL_COLLECTOR_GRPC_URL=${SUITE_OBS_OTEL_COLLECTOR_GRPC_URL}
      - LOG_LEVEL=info
    volumes:
      - archify_storage_originals:/var/archify/documents
    networks:
      - net_suite_internal
      - net_backing_services
      - net_observability
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=${PROXY_NETWORK_INTERNAL:-geniuserp_net_suite_internal}"
      - "traefik.http.routers.archify.rule=Host(`archify.${SUITE_APP_DOMAIN:-geniuserp.app}`)"
      - "traefik.http.routers.archify.entrypoints=websecure"
      - "traefik.http.routers.archify.tls=true"
      - "traefik.http.routers.archify.tls.certresolver=letsencrypt"
      - "traefik.http.routers.archify.middlewares=global-chain@file"
      - "traefik.http.services.archify.loadbalancer.server.port=${ARCHY_APP_PORT:-6500}"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${ARCHY_APP_PORT:-6500}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  net_suite_internal:
    external: true
    name: geniuserp_net_suite_internal
  net_backing_services:
    external: true
    name: geniuserp_net_backing_services
  net_observability:
    external: true
    name: geniuserp_net_observability

volumes:
  archify_storage_originals:
    external: true
