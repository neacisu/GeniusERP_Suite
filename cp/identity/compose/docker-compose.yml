services:
  identity:
    build:
      context: ../../..
      dockerfile: cp/identity/Dockerfile
    container_name: genius-suite-identity
    ports:
      - "${CP_IDT_APP_PORT}:${CP_IDT_APP_PORT}"
    env_file:
      - ../../../.suite.general.env
      - ../.cp.identity.env
      # ⚠️ Secretele sunt injectate de OpenBao; fișierele de mai sus conțin doar configurări non-secrete
    environment:
      - CP_IDT_APP_PORT=${CP_IDT_APP_PORT}
      - CP_IDT_APP_METRICS_PORT=${CP_IDT_APP_METRICS_PORT}
      - CP_IDT_APP_NODE_ENV=${CP_IDT_APP_NODE_ENV}
      - CP_IDT_OBS_SERVICE_NAME=${CP_IDT_OBS_SERVICE_NAME}
      - SUITE_OBS_OTEL_COLLECTOR_GRPC_URL=${SUITE_OBS_OTEL_COLLECTOR_GRPC_URL}
      - BAO_AGENT_CONFIG=${CP_IDT_BAO_AGENT_CONFIG}
      - SUITE_DB_POSTGRES_HOST=${SUITE_DB_POSTGRES_HOST}
      - SUITE_DB_POSTGRES_PORT=${SUITE_DB_POSTGRES_PORT}
      - LOG_LEVEL=info
    volumes:
      - ${CP_IDT_APPROLE_ROLE_ID_PATH}:/openbao/role-id:ro
      - ${CP_IDT_APPROLE_SECRET_ID_PATH}:/openbao/secret-id:ro
    networks:
      - net_suite_internal
      - net_backing_services
      - net_observability
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=${PROXY_NETWORK_INTERNAL:-geniuserp_net_suite_internal}"
      - "traefik.http.routers.identity.rule=Host(`identity.${SUITE_APP_DOMAIN:-geniuserp.app}`)"
      - "traefik.http.routers.identity.entrypoints=websecure"
      - "traefik.http.routers.identity.tls=true"
      - "traefik.http.routers.identity.tls.certresolver=letsencrypt"
      - "traefik.http.routers.identity.middlewares=global-chain@file"
      - "traefik.http.services.identity.loadbalancer.server.port=${CP_IDT_APP_PORT:-6250}"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://127.0.0.1:6250/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  net_suite_internal:
    external: true
    name: geniuserp_net_suite_internal
  net_backing_services:
    external: true
    name: geniuserp_net_backing_services
  net_observability:
    external: true
    name: geniuserp_net_observability
