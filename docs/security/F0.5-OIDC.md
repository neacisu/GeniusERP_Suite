# OpenBao OIDC Authentication for GitHub Actions

## Overview

This document describes the OIDC (OpenID Connect) trust configuration between GitHub Actions and OpenBao, enabling CI/CD workflows to authenticate without static tokens.

## Architecture

```text
GitHub Actions Workflow
        ↓
   (OIDC Token Request)
        ↓
GitHub OIDC Provider
(token.actions.githubusercontent.com)
        ↓
   (JWT Token with claims)
        ↓
OpenBao JWT Auth Method
        ↓
   (Validate claims & issue token)
        ↓
OpenBao Token (15min TTL)
        ↓
Access Secrets (KV, DB creds)
```

## Benefits

1. **No Static Secrets**: Eliminates `BAO_TOKEN` from GitHub Secrets
2. **Short-Lived Tokens**: 15-minute TTL, max 1 hour
3. **Fine-Grained Access**: Bound to specific repository and claims
4. **Audit Trail**: All authentications logged in OpenBao
5. **Automatic Rotation**: No manual token management

## Configuration

### Prerequisites

- OpenBao running and unsealed
- Root or admin token for initial setup
- GitHub repository: `neacisu/GeniusERP_Suite`

### Setup Script

Run the configuration script:

```bash
export BAO_TOKEN=$(jq -r '.root_token' .secrets/openbao-keys.json)
export BAO_ADDR=http://127.0.0.1:8200

./scripts/security/openbao-configure-oidc.sh
```

This script:

1. Enables JWT/OIDC auth method
2. Configures GitHub as OIDC provider
3. Creates `github-actions` role with claim bindings
4. Creates `ci-cd-read` policy for secret access
5. Verifies configuration

### Manual Configuration

If you need to configure manually:

```bash
# 1. Enable JWT auth
bao auth enable jwt

# 2. Configure GitHub OIDC
bao write auth/jwt/config \
    oidc_discovery_url="https://token.actions.githubusercontent.com" \
    bound_issuer="https://token.actions.githubusercontent.com"

# 3. Create role
bao write auth/jwt/role/github-actions \
    role_type="jwt" \
    bound_audiences="https://github.com/neacisu" \
    user_claim="actor" \
    bound_claims='{"repository":"neacisu/GeniusERP_Suite"}' \
    token_ttl="15m" \
    token_max_ttl="1h" \
    token_policies="ci-cd-read"

# 4. Create policy
bao policy write ci-cd-read - <<EOF
path "kv/data/apps/*" {
  capabilities = ["read", "list"]
}
path "database/creds/*" {
  capabilities = ["read"]
}
EOF
```

## GitHub Actions Integration

### Workflow Configuration

Add to your `.github/workflows/*.yml`:

```yaml
name: CI/CD with OpenBao OIDC

on:
  push:
    branches: [main, develop]
  pull_request:

# CRITICAL: Enable id-token permission for OIDC
permissions:
  id-token: write
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # Authenticate with OpenBao using OIDC
      - name: Get OpenBao Token
        id: openbao
        uses: hashicorp/vault-action@v2
        with:
          url: ${{ secrets.OPENBAO_ADDR }}
          role: github-actions
          method: jwt
          secrets: |
            kv/data/apps/numeriqo jwt_secret | NUMQ_JWT_SECRET ;
            database/creds/numeriqo_runtime username | DB_USER ;
            database/creds/numeriqo_runtime password | DB_PASS
      
      # Use secrets in subsequent steps
      - name: Run Tests
        env:
          JWT_SECRET: ${{ steps.openbao.outputs.NUMQ_JWT_SECRET }}
          DB_USER: ${{ steps.openbao.outputs.DB_USER }}
          DB_PASS: ${{ steps.openbao.outputs.DB_PASS }}
        run: npm test
```

### Required GitHub Secrets

Only one secret needed (down from multiple):

- `OPENBAO_ADDR`: OpenBao server URL (e.g., `https://openbao.geniuserp.app`)

**Remove these** (no longer needed):

- ~~`BAO_TOKEN`~~ (replaced by OIDC)
- ~~`DB_PASSWORD`~~ (from OpenBao)
- ~~`JWT_SECRET`~~ (from OpenBao)

## Claim Mappings

The OIDC token from GitHub includes these claims:

```json
{
  "iss": "https://token.actions.githubusercontent.com",
  "aud": "https://github.com/neacisu",
  "sub": "repo:neacisu/GeniusERP_Suite:ref:refs/heads/main",
  "repository": "neacisu/GeniusERP_Suite",
  "repository_owner": "neacisu",
  "actor": "username",
  "workflow": "CI/CD",
  "ref": "refs/heads/main"
}
```

### Bound Claims

Our configuration binds to:

- **repository**: `neacisu/GeniusERP_Suite` (exact match)
- **issuer**: `https://token.actions.githubusercontent.com` (exact match)
- **audience**: `https://github.com/neacisu` (exact match)

### User Claim

The `actor` claim is mapped to the OpenBao user, enabling audit logs to show which GitHub user triggered the workflow.

## Security Considerations

### Token TTL

- **Default TTL**: 15 minutes
- **Max TTL**: 1 hour
- **Renewable**: No (workflows should re-authenticate if needed)

Short TTLs minimize risk if a token is leaked.

### Claim Validation

**DO**:

- ✅ Use exact repository match
- ✅ Bind to specific issuer
- ✅ Use specific audience
- ✅ Validate all claims

**DON'T**:

- ❌ Use wildcard claims (`*`)
- ❌ Accept tokens from any repository
- ❌ Use long TTLs (>1h)
- ❌ Grant write access unless necessary

### Policy Restrictions

The `ci-cd-read` policy:

- ✅ Read-only access to KV secrets
- ✅ Read-only access to DB credentials
- ❌ No write access
- ❌ No policy management
- ❌ No auth method configuration

## Troubleshooting

### Authentication Fails

**Error**: `permission denied`

**Solution**:

1. Check role configuration: `bao read auth/jwt/role/github-actions`
2. Verify repository claim matches exactly
3. Check policy is attached: `bao token lookup` (with token)

### Invalid Audience

**Error**: `audience claim does not match`

**Solution**:

Update role with correct audience:

```bash
bao write auth/jwt/role/github-actions \
    bound_audiences="https://github.com/neacisu"
```

### Token Expired

**Error**: `token expired`

**Solution**:
Re-authenticate in workflow. Tokens expire after 15 minutes by design.

## Validation

Test OIDC authentication:

```bash
# 1. Get OIDC token from GitHub (in workflow)
GITHUB_TOKEN=$(curl -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
  "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=https://github.com/neacisu" | jq -r .value)

# 2. Authenticate with OpenBao
BAO_TOKEN=$(bao write -field=token auth/jwt/login \
  role=github-actions \
  jwt=$GITHUB_TOKEN)

# 3. Test access
bao kv get kv/apps/numeriqo
```

## Monitoring

### Audit Logs

All OIDC authentications are logged:

```bash
# View recent auth attempts
bao audit list
bao read sys/audit-hash/file
```

### Metrics

Track OIDC usage:

- Authentication success/failure rate
- Token TTL usage
- Policy violations

## Migration from Static Tokens

1. **Setup OIDC** (this document)
2. **Update workflows** to use OIDC
3. **Test** in development branch
4. **Deploy** to main branch
5. **Remove** static `BAO_TOKEN` from GitHub Secrets
6. **Revoke** old tokens in OpenBao

## References

- [OpenBao JWT/OIDC Auth](https://openbao.org/docs/auth/jwt/)
- [GitHub OIDC](https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect)
- [Vault Action](https://github.com/hashicorp/vault-action)

## Support

For issues or questions:

1. Check troubleshooting section above
2. Review OpenBao audit logs
3. Verify GitHub Actions logs
4. Contact security team
