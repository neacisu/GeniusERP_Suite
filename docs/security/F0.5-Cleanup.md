# Security Cleanup and Rotation Procedure

## Overview

This document outlines the procedure for cleaning up static secrets after the successful migration to OpenBao and OIDC authentication. It also covers the rotation of migrated credentials to ensure that any old static values are invalidated.

## 1. GitHub Secrets Cleanup

With OIDC configured (F0.5.19) and workflows updated (F0.5.21), static long-lived secrets in GitHub Actions are no longer needed.

### Secrets to Remove

Remove the following secrets from repository settings (`Settings > Secrets and variables > Actions`):

- `BAO_TOKEN` (Replaced by OIDC)
- `GH_PAT_TOKEN` (Injected via OpenBao)
- `NPM_TOKEN` (Injected via OpenBao)
- `DB_PASSWORD` (Replaced by dynamic creds)
- `JWT_SECRET` (Injected via OpenBao)
- `DOCKER_USERNAME` / `DOCKER_PASSWORD` (Injected via OpenBao)

### Secrets to Keep

- `OPENBAO_ADDR`: The public URL of the OpenBao server (required for OIDC login).

## 2. Credential Rotation

To ensure complete security, all static secrets that were migrated to OpenBao KV must be rotated. This invalidates any copies that might exist in developer `.env` files or old backups.

### Rotation Checklist

| Secret Type | Location in OpenBao | Rotation Method | Impact |
|-------------|---------------------|-----------------|--------|
| **Database Users** | `database/creds/*` | Automatic (Lease expiry) | Zero downtime (if apps use dynamic creds) |
| **JWT Secrets** | `kv/data/apps/*/jwt_secret` | Manual (Generate new) | Users logged out |
| **API Keys** | `kv/data/apps/*/api_key` | Manual (Regenerate) | API clients need update (if static) |
| **Encryption Keys** | `kv/data/apps/*/encryption_key` | **CAUTION** | Data loss if not handled correctly (Key versioning) |
| **GitHub PAT** | `kv/data/deployments/github` | Generate new in GitHub | CI/CD using old token fails |
| **NPM Token** | `kv/data/deployments/npm` | Generate new in NPM | Publishing fails |

### Rotation Procedure

#### 1. Database Credentials

Dynamic credentials rotate automatically. To force rotation of the *root* connection used by OpenBao:

1. Update password in PostgreSQL.
2. Update OpenBao database config:

   ```bash
   bao write database/config/postgresql \
       plugin_name=postgresql-database-plugin \
       allowed_roles="*" \
       connection_url="postgresql://{{username}}:{{password}}@postgres:5432/postgres" \
       username="root" \
       password="NEW_PASSWORD"
   ```

#### 2. JWT Secrets (Application)

1. Generate new secret: `openssl rand -base64 32`
2. Update OpenBao:

   ```bash
   bao kv patch kv/data/apps/numeriqo jwt_secret="NEW_SECRET"
   ```

3. Restart application (Process Supervisor will pick up new secret on restart).

#### 3. GitHub PAT

1. Generate new PAT in GitHub (Scopes: repo, read:packages).
2. Update OpenBao:

   ```bash
   bao kv patch kv/data/deployments/github pat_token="ghp_NEW_TOKEN"
   ```

## 3. Verification

After cleanup and rotation:

1. **Verify CI/CD**: Run a release workflow. It should succeed using OIDC and the new PAT.
2. **Verify Apps**: Restart an app. It should start successfully with new secrets.
3. **Verify Old Access**: Try to use an old static token (if saved). It should fail.

## 4. Emergency Rollback

If rotation causes issues:

1. Restore previous value in OpenBao KV (OpenBao keeps versions).

   ```bash
   bao kv get -version=1 kv/data/apps/numeriqo
   ```

2. If GitHub Secret deletion broke something (e.g. a legacy workflow), restore the secret manually in GitHub Settings.
