# GeniusERP Suite - Cryptographic Standards for OpenBao

> **Document Version**: 1.0  
> **Last Updated**: 2025-11-21  
> **Status**: Official Internal Standard  
> **Scope**: All cryptographic operations within GeniusERP Suite

## Executive Summary

This document defines the minimum cryptographic requirements for all secrets, keys, and sensitive data managed within the GeniusERP Suite. All components MUST adhere to these standards to ensure security, compliance, and auditability.

---

## Minimum Requirements

| Requirement | Standard | Rationale |
|-------------|----------|-----------|
| **Entropy** | ≥ 256 bits (32 bytes) | Industry best practice for high-security applications |
| **Character Set** | Base64 or Hex | URL-safe and database-friendly encoding |
| **Rotation Period** | Maximum 90 days | Limit exposure window for compromised keys |
| **Storage** | OpenBao KV v2 or Dynamic Secrets | Never in plaintext files or Git |
| **Transport** | TLS 1.3+ | Encrypted in-transit |

---

## Approved Algorithms

### Symmetric Encryption

| Algorithm | Key Size | Use Case | Status |
|-----------|----------|----------|--------|
| **AES-256-GCM** | 256 bits | Application-level encryption | ✅ Recommended |
| **ChaCha20-Poly1305** | 256 bits | Alternative for ARM/mobile | ✅ Approved |
| AES-128-GCM | 128 bits | Legacy systems | ⚠️ Acceptable |

**Prohibited**: DES, 3DES, RC4, AES-ECB

### Asymmetric Encryption

| Algorithm | Key Size | Use Case | Status |
|-----------|----------|----------|--------|
| **RSA** | ≥ 4096 bits | Certificate generation, key exchange | ✅ Recommended |
| **Ed25519** | 256 bits | SSH keys, JWT signing | ✅ Recommended |
| **ECDSA (P-256)** | 256 bits | JWT signing, TLS certificates | ✅ Approved |

**Prohibited**: RSA < 2048, DSA

### Hashing

| Algorithm | Output Size | Use Case | Status |
|-----------|-------------|----------|--------|
| **SHA-256** | 256 bits | General hashing, checksums | ✅ Recommended |
| **SHA-512** | 512 bits | High-security hashing | ✅ Approved |
| **BLAKE2b** | 256-512 bits | Modern alternative to SHA-2 | ✅ Approved |

**Prohibited**: MD5, SHA-1

### Password Hashing

| Algorithm | Parameters | Use Case | Status |
|-----------|------------|----------|--------|
| **Argon2id** | m=65536, t=3, p=4 | User passwords | ✅ Recommended |
| **bcrypt** | Cost ≥ 12 | Legacy password migration | ✅ Approved |
| **scrypt** | N=32768, r=8, p=1 | Alternative for specific use cases | ✅ Approved |

**Prohibited**: PBKDF2, plain SHA-256

---

## Key Generation Standards

### JWT Secrets

**Minimum**: 256 bits (32 bytes) of cryptographically secure random data

```bash
# Generate a 256-bit JWT secret
openssl rand -base64 32

# Alternative with explicit 32-byte output
openssl rand -base64 32 | tr -d "=+/" | cut -c1-32
```

**Validation**:

```bash
# Check entropy (should be ≥32 bytes)
echo -n "your-secret" | wc -c
```

### API Keys

**Minimum**: 256 bits encoded as Base64 or Hex

```bash
# Generate API key with prefix
echo "gserp_$(openssl rand -hex 32)"

# Generate Base64 API key
openssl rand -base64 32 | tr -d "=+/"
```

### Database Passwords

**Minimum**: 128 bits for development, 256 bits for production

```bash
# Production database password (32 characters, mixed charset)
openssl rand -base64 32 | tr -d "=+/" | cut -c1-32

# With special characters
LC_ALL=C tr -dc 'A-Za-z0-9!@#$%^&*()_+-=' < /dev/urandom | head -c 32
```

### TLS Certificates

**Minimum**: RSA 4096-bit or ECDSA P-256

```bash
# Generate RSA 4096-bit private key
openssl genrsa -out private-key.pem 4096

# Generate ECDSA P-256 private key
openssl ecparam -name prime256v1 -genkey -noout -out ec-private-key.pem

# Generate CSR
openssl req -new -key private-key.pem -out request.csr
```

### SSH Keys

**Minimum**: Ed25519 or RSA 4096-bit

```bash
# Generate Ed25519 SSH key (recommended)
ssh-keygen -t ed25519 -C "geniuserp-deploy@example.com"

# Generate RSA 4096-bit SSH key
ssh-keygen -t rsa -b 4096 -C "geniuserp-deploy@example.com"
```

---

## Key Rotation Procedures

### Automated Rotation (OpenBao)

**Dynamic Database Credentials**: Auto-rotated by OpenBao on every lease renewal (default: 1 hour TTL)

```bash
# Example: Get fresh database credentials
bao read database/creds/numeriqo-role
# Output includes lease_id and lease_duration
```

**KV Secrets**: Manual rotation every 90 days or on suspected compromise

### Manual Rotation Workflow

1. **Generate New Secret**:

   ```bash
   NEW_SECRET=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-32)
   ```

2. **Update OpenBao**:

   ```bash
   bao kv put kv/cp/identity/jwt-secret value="$NEW_SECRET"
   ```

3. **Rolling Update Services**:

   ```bash
   # Restart services one by one to prevent downtime
   docker compose restart identity
   ```

4. **Verify**:

   ```bash
   # Check service logs for successful authentication
   docker logs geniuserp-identity --tail 50
   ```

5. **Document Rotation**:

   ```bash
   # Log rotation in audit trail
   echo "$(date -u +%Y-%m-%d) - Rotated jwt-secret for identity" >> .secrets/rotation-log.txt
   ```

### Emergency Rotation (Compromise)

If a secret is suspected to be compromised:

1. **Immediate**: Rotate secret within 1 hour
2. **Revoke**: Invalidate all tokens/sessions using old secret
3. **Audit**: Review access logs for unauthorized usage
4. **Post-mortem**: Document incident and prevention measures

---

## OpenBao Integration

### Storing Secrets in OpenBao

```bash
# Store a generated secret
SECRET_VALUE=$(openssl rand -base64 32 | tr -d "=+/")
bao kv put kv/apps/myapp/api-key value="$SECRET_VALUE"

# Retrieve secret
bao kv get -field=value kv/apps/myapp/api-key
```

### Dynamic Database Credentials

```bash
# Configure PostgreSQL dynamic secrets engine
bao write database/config/postgres \
    plugin_name=postgresql-database-plugin \
    allowed_roles="numeriqo-role,archify-role" \
    connection_url="postgresql://{{username}}:{{password}}@postgres:5432/postgres"

# Create role
bao write database/roles/numeriqo-role \
    db_name=postgres \
    creation_statements="CREATE ROLE \"{{name}}\" WITH LOGIN PASSWORD '{{password}}' VALID UNTIL '{{expiration}}'; \
    GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO \"{{name}}\";" \
    default_ttl="1h" \
    max_ttl="24h"

# Get credentials
bao read database/creds/numeriqo-role
```

---

## Encryption at Rest

### Application-Level Encryption

Use OpenBao Transit Secrets Engine for encryption as a service:

```bash
# Enable transit engine
bao secrets enable transit

# Create encryption key
bao write -f transit/keys/geniuserp-pii

# Encrypt data
bao write transit/encrypt/geniuserp-pii plaintext=$(echo -n "sensitive-data" | base64)

# Decrypt data
bao write transit/decrypt/geniuserp-pii ciphertext="vault:v1:..."
```

### Database Encryption

**PostgreSQL**: Use `pgcrypto` extension or Transparent Data Encryption (TDE)

```sql
-- Enable pgcrypto
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- Encrypt column
INSERT INTO users (email, ssn_encrypted) 
VALUES ('user@example.com', pgp_sym_encrypt('123-45-6789', 'encryption-key'));

-- Decrypt column
SELECT pgp_sym_decrypt(ssn_encrypted::bytea, 'encryption-key') FROM users;
```

---

## Compliance and Audit

### Audit Trail Requirements

All secret operations MUST be logged:

1. **Creation**: When secret was generated and by whom
2. **Access**: When secret was retrieved (OpenBao audit log)
3. **Rotation**: When secret was rotated and reason
4. **Deletion**: When secret was revoked

### OpenBao Audit Logging

```bash
# Enable file audit device
bao audit enable file file_path=/vault/logs/audit.log

# View recent audit entries
docker exec geniuserp-openbao tail -f /vault/logs/audit.log
```

### Compliance Standards

| Standard | Requirement | GeniusERP Implementation |
|----------|-------------|--------------------------|
| **GDPR** | Data encryption | ✅ AES-256-GCM + OpenBao |
| **PCI DSS** | Key management | ✅ OpenBao + 90-day rotation |
| **SOC 2** | Access logging | ✅ OpenBao audit logs |
| **HIPAA** | Secure key storage | ✅ OpenBao KV v2 |

---

## Prohibited Practices

| ❌ Never | ✅ Instead |
|---------|-----------|
| Commit secrets to Git | Store in OpenBao KV |
| Use weak passwords (< 12 chars) | Generate 256-bit secrets |
| MD5 or SHA-1 hashing | Use SHA-256 or BLAKE2b |
| Hardcode API keys in code | Inject from OpenBao at runtime |
| Share secrets via email/Slack | Use OpenBao secret sharing |
| Store plaintext in databases | Encrypt with Transit engine |

---

## Examples and Tools

### age (Modern Encryption Tool)

```bash
# Generate age key pair
age-keygen -o key.txt

# Encrypt file
age -r $(cat key.txt.pub) -o encrypted.age plaintext.txt

# Decrypt file
age -d -i key.txt -o plaintext.txt encrypted.age
```

### gpg (Legacy Compatibility)

```bash
# Generate GPG key
gpg --full-generate-key

# Encrypt file
gpg --encrypt --recipient devops@geniuserp.app sensitive-file.txt

# Decrypt file
gpg --decrypt sensitive-file.txt.gpg
```

### Password Manager Integration

For local development, use `pass` with OpenBao backend:

```bash
# Store secret in pass
pass insert geniuserp/dev/jwt-secret

# Retrieve secret
pass show geniuserp/dev/jwt-secret
```

---

## References

- **OpenBao Documentation**: `https://openbao.org/docs/`
- **NIST SP 800-57**: Key Management Recommendations
- **OWASP Cryptographic Storage Cheat Sheet**: `https://cheatsheetseries.owasp.org/`
- **Mozilla SSL Configuration Generator**: `https://ssl-config.mozilla.org/`

---

## Changelog

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2025-11-21 | Initial standard published |

---

**Approval Required**: This document must be reviewed and approved by the Security Officer before implementation.

**Review Cycle**: Annually or after major security incidents.
