services:
  numeriqo-app:
    build:
      context: ../..
      dockerfile: numeriqo.app/Dockerfile
    container_name: genius-suite-numeriqo-app
    restart: unless-stopped
    env_file:
      - ../../.suite.general.env
      # NOTE: .numeriqo.env removed - secrets now injected via OpenBao Agent
    environment:
      - NUMQ_APP_PORT=${NUMQ_APP_PORT:-6750}
      - NUMQ_APP_METRICS_PORT=${NUMQ_APP_METRICS_PORT:-9090}
      - NUMQ_APP_WORKER_PORT=${NUMQ_APP_WORKER_PORT:-6751}
      - NUMQ_APP_NODE_ENV=${NUMQ_APP_NODE_ENV:-production}
      - PORT=${NUMQ_APP_PORT:-6750}
      - OTEL_SERVICE_NAME=numeriqo.app
      - SUITE_OBS_OTEL_COLLECTOR_GRPC_URL=${SUITE_OBS_OTEL_COLLECTOR_GRPC_URL}
      - LOG_LEVEL=info
      - BAO_AGENT_CONFIG=/openbao/agent-config.hcl
      - SUITE_DB_POSTGRES_HOST=${SUITE_DB_POSTGRES_HOST}
      - SUITE_DB_POSTGRES_PORT=${SUITE_DB_POSTGRES_PORT}
    volumes:
      # OpenBao AppRole credentials (mounted from host)
      - ../../.secrets/approle/numeriqo/role-id:/openbao/role-id:ro
      - ../../.secrets/approle/numeriqo/secret-id:/openbao/secret-id:ro
    networks:
      - net_suite_internal
      - net_backing_services
      - net_observability
    labels:
      - 'traefik.enable=true'
      - 'traefik.docker.network=${PROXY_NETWORK_INTERNAL:-geniuserp_net_suite_internal}'
      - 'traefik.http.routers.numeriqo.rule=Host(`numeriqo.${SUITE_APP_DOMAIN:-geniuserp.app}`)'
      - 'traefik.http.routers.numeriqo.entrypoints=websecure'
      - 'traefik.http.routers.numeriqo.tls=true'
      - 'traefik.http.routers.numeriqo.tls.certresolver=letsencrypt'
      - 'traefik.http.routers.numeriqo.middlewares=global-chain@file'
      - 'traefik.http.services.numeriqo.loadbalancer.server.port=${NUMQ_APP_PORT:-6750}'
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:${NUMQ_APP_PORT:-6750}/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s # Increased to allow OpenBao Agent to render secrets

networks:
  net_suite_internal:
    external: true
    name: geniuserp_net_suite_internal
  net_backing_services:
    external: true
    name: geniuserp_net_backing_services
  net_observability:
    external: true
    name: geniuserp_net_observability
